## mysql抖动


### 脏页和干净页

- 脏页：内存数据页和磁盘数据页内容不一致
- 干净页：内存数据页和磁盘数据页内容一致




### 抖动的原因

- 平时执行很快的更新操作，实际上只是执行了一次内存更新操作，以及写了两次磁盘（binlog和redolog）
- 抖动其实是因为innodb在刷脏页，这个过程需要占用一些io资源，影响到了语句的执行


### 什么情况会触发刷脏页的过程

- redolog写满了，需要留出redolog的空间继续写，此时所有的更新操作都停止
  - innodb要避免的情况，因为所有更新操作都将停止
- 系统内存不足，需要淘汰一些数据页，空出一些内存给别的数据页使用
  - 这是一种常态
  - innodb使用缓冲池来管理内存，缓冲池中的内存页有三种状态
    - 还没使用的
      - innodb的策略是尽量使用内存，所以这种情况很少
    - 使用了是干净页的
      - 读入数据时内存不够，kill掉的数据页是干净页的话，直接释放内存复用
    - 使用了不是干净页的
      - 先flash到磁盘，变成干净页后才能复用
  - 淘汰的是干净页，直接kill掉
  - 淘汰的是脏页，先将脏页落磁盘
- 系统空闲的时候，只要有机会就刷脏页
- 数据库正常关闭的时候，mysql会把内存的脏也都flash到磁盘上



### 刷脏页影响性能的两种情况

- 一个查询淘汰的脏页太多，导致查询的响应时间变长
- 日志写满




### innodb刷脏页的控制策略


- 通过`innodb_io_capacity`参数告诉innodb你的磁盘能力（IOPS）
- 通过`innodb_dirty_pages_pct`参数设置脏页比例
  - 根据这个脏页比例计算出0-100之间的数字，记为F1
  - innodb每次写入日志都会有一个序号，根据这个序号，做一些逻辑计算得出一个0-100之间的数字，记为F2
  - 取max{F1,F2} --> R%
  - 之后innodb根据`innodb_io_capacity` * `R%` 来控制刷脏页的速度

- 一个有趣的策略
  - 在准备刷一下脏页的时候，如果这个数据页旁边刚好是脏页，那么innodb会顺带把这个页也一起刷，然后会无限蔓延（俄罗斯套娃）
  - 通过设置`innodb_flash_neighbors`来控制脏页刷磁盘策略
    - 设置为0，表示只刷自己的
    - 设置为1，只要当前刷的脏页的旁边也是脏页，就会顺带也刷进磁盘中