## mysql为什么会选错索引


### 优化器的逻辑

- 优化器选择索引的目的，是找一个最优的执行方案，并用最小的代价去执行语句
- 判断标准
  - 是否使用临时表
  - 是否排序
  - 扫描行数
    - 怎么判断？
      - 统计信息
        - 基数
          - 如何得到索引的基数
            - innodb会选择n个数据页，统计这些页的不同值，得到一个平均值
            - 然后根据这个平均值乘以这个索引的所有页数，就得到了索引的基数
        - 区分度
      - 计算扫描行数
        - 如果使用某个索引a，那么它就需要回表，而使用索引b是全表扫描，直接在主键索引树上直接获取记录，优化器认为直接扫描主键索引更快
          - 通过`analyze table`命令重新统计索引信息（适用于索引信息统计不准确的情况）
        - select * from t where a between 1 and 1000 and b between 50000 and 100000 order by b limit 1
          - 选择a索引，扫描索引a的前1000个值，然后拿到对应的主键id，去主键索引树上找对应的记录，根据字段b来进行过滤，也需要扫描1000行
          - 选择索引b，扫描索引b的最后50001个值，然后拿到对应的主键id，去主键索引树上找对应的记录，根据字段a进行过滤，也需要扫描50001行
          - 优化器会选择索引b，因为字段b本身是索引，索引本身有序，只需要遍历不需要排序，尽管扫描行数更多，也判断为代价最小
          - 改进方法
            - 使用 force index(a)来强制使用索引a
              - 矫正优化器选择正确索引的作用
              - 语句中添加force不优美
              - 索引改了名字，语句也需要改
              - 数据库迁移的时候，这个语法不知是否可以兼容
              - 对于生产系统来说，不够敏捷（线上出现问题，临时fuck，还需要测试和发布）
            - 添加order by b，a
              - 使用这两个索引都需要排序
              - 此时扫描行数成为了影响行数的关键
              - 优化器此时就会选择索引a